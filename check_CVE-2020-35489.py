#!/usr/bin/python3.8


from factory import Factory
import requests
import sys, getopt
from packaging import version


in_file = ''
out_file = ''
domain = ''
Help = """
python3.8 check_CVE-2020-35489.py -i <inputfile> -o <outputfile>
python3.8 check_CVE-2020-35489.py -d <domain>
"""

def find_plugin_version(str_response):
    for line in str_response:
        if line.find('Stable tag: ') == 0:
            return line[12:].strip()


def check(domain):
    try:
        c_domain = domain + '/wp-content/plugins/contact-form-7/readme.txt'
        r = requests.get(c_domain, timeout = 3.0)
        if r.ok:
            version = find_plugin_version(r.content)
            if in_file == '':
                print("Contact Form 7 version: " + str(version))
                if version.parse(version) < version.parse("5.3.2"):
                    print(domain + "is vulnerable!")
                else:
                    print(domain + "is not vulnerable!")
            else:
                if version.parse(version) < version.parse("5.3.2"):
                    open(out_file,"a").write(domain)
    except:
        pass


def main(argv):
    try:
        opts, args = getopt.getopt(argv,"hi:o:d:",["ifile=","ofile=","domain="])

        for opt, arg in opts:
            if opt == '-h':
                print(Help)
                sys.exit()
            elif opt in ("-i", "--infile"):
                in_file = arg
            elif opt in ("-o", "--outfile"):
                out_file = arg
            elif opt in ("-d",  "--domain"):
                domain = arg

        if in_file == '':
            tasks = [tuple(line.strip().split(":")) for line in open(in_file,'r') if line.strip() != ""]
            factory = Factory(check, tasks, workers=512)
            factory.start(wait=True)
            exit()
        else:
            check(domain)
            exit()
    except getopt.GetoptError:
        print(Help)
        sys.exit(2)


if __name__ == "__main__":
    main(sys.argv[1:])